depth2 = ListOffsetArray([0, 3, 6], ListOffsetArray([0, 5, 10, 15, 20, 25, 30], RawArray(primes[:2*3*5])))
assert depth2.tolist() == [
    [[  2,   3,   5,   7,  11],
     [ 13,  17,  19,  23,  29],
     [ 31,  37,  41,  43,  47]],
    [[ 53,  59,  61,  67,  71],
     [ 73,  79,  83,  89,  97],
     [101, 103, 107, 109, 113]]]

assert list(depth2.reduce(-3)) == [
    [ 106,  177,  305,  469,  781],
    [ 949, 1343, 1577, 2047, 2813],
    [3131, 3811, 4387, 4687, 5311]]

depth2 = ListOffsetArray([1, 4, 7], ListOffsetArray([0, 1, 6, 11, 16, 21, 26, 31], RawArray([123] + primes[:2*3*5])))
assert depth2.tolist() == [
    [[  2,   3,   5,   7,  11],
     [ 13,  17,  19,  23,  29],
     [ 31,  37,  41,  43,  47]],
    [[ 53,  59,  61,  67,  71],
     [ 73,  79,  83,  89,  97],
     [101, 103, 107, 109, 113]]]

assert list(depth2.reduce(-3)) == [
    [ 106,  177,  305,  469,  781],
    [ 949, 1343, 1577, 2047, 2813],
    [3131, 3811, 4387, 4687, 5311]]

depth2 = ListOffsetArray([0, 3, 6], ListOffsetArray([0, 5, 10, 15, 20, 25, 29], RawArray(primes[:2*3*5 - 1])))
assert depth2.tolist() == [
    [[  2,   3,   5,   7,  11],
     [ 13,  17,  19,  23,  29],
     [ 31,  37,  41,  43,  47]],
    [[ 53,  59,  61,  67,  71],
     [ 73,  79,  83,  89,  97],
     [101, 103, 107, 109     ]]]

assert list(depth2.reduce(-3)) == [
    [ 106,  177,  305,  469,  781],
    [ 949, 1343, 1577, 2047, 2813],
    [3131, 3811, 4387, 4687,   47]]

depth2 = ListOffsetArray([0, 3, 6], ListOffsetArray([0, 5, 10, 15, 20, 25, 28], RawArray(primes[:2*3*5 - 2])))
assert depth2.tolist() == [
    [[  2,   3,   5,   7,  11],
     [ 13,  17,  19,  23,  29],
     [ 31,  37,  41,  43,  47]],
    [[ 53,  59,  61,  67,  71],
     [ 73,  79,  83,  89,  97],
     [101, 103, 107,         ]]]

assert list(depth2.reduce(-3)) == [
    [ 106,  177,  305,  469,  781],
    [ 949, 1343, 1577, 2047, 2813],
    [3131, 3811, 4387,   43,   47]]

depth2 = ListOffsetArray([0, 3, 6], ListOffsetArray([0, 5, 10, 15, 20, 24, 28], RawArray([2, 3, 5, 7, 11, 13, 17, 19, 23, 29, 31, 37, 41, 43, 47, 53, 59, 61, 67, 71, 73, 79, 83, 89, 101, 103, 107, 109])))
assert depth2.tolist() == [
    [[  2,   3,   5,   7,  11],
     [ 13,  17,  19,  23,  29],
     [ 31,  37,  41,  43,  47]],
    [[ 53,  59,  61,  67,  71],
     [ 73,  79,  83,  89,    ],
     [101, 103, 107, 109     ]]]

assert list(depth2.reduce(-3)) == [
    [ 106,  177,  305,  469, 781],
    [ 949, 1343, 1577, 2047,  29],
    [3131, 3811, 4387, 4687,  47]]

depth2 = ListOffsetArray([0, 3, 6], ListOffsetArray([0, 4, 9, 14, 19, 24, 29], RawArray(primes[1:2*3*5])))
assert depth2.tolist() == [
    [[  3,   5,   7,  11     ],
     [ 13,  17,  19,  23,  29],
     [ 31,  37,  41,  43,  47]],
    [[ 53,  59,  61,  67,  71],
     [ 73,  79,  83,  89,  97],
     [101, 103, 107, 109, 113]]]

assert list(depth2.reduce(-3)) == [
    [ 159,  295,  427,  737,   71],
    [ 949, 1343, 1577, 2047, 2813],
    [3131, 3811, 4387, 4687, 5311]]

depth2 = ListOffsetArray([0, 3, 6], ListOffsetArray([0, 3, 8, 13, 18, 23, 28], RawArray(primes[2:2*3*5])))
assert depth2.tolist() == [
    [[  5,   7,  11          ],
     [ 13,  17,  19,  23,  29],
     [ 31,  37,  41,  43,  47]],
    [[ 53,  59,  61,  67,  71],
     [ 73,  79,  83,  89,  97],
     [101, 103, 107, 109, 113]]]

assert list(depth2.reduce(-3)) == [
    [ 265,  413,  671,   67,   71],
    [ 949, 1343, 1577, 2047, 2813],
    [3131, 3811, 4387, 4687, 5311]]

depth2 = ListOffsetArray([0, 3, 6], ListOffsetArray([0, 3, 8, 13, 18, 23, 28], RawArray([3, 5, 7, 13, 17, 19, 23, 29, 31, 37, 41, 43, 47, 53, 59, 61, 67, 71, 73, 79, 83, 89, 97, 101, 103, 107, 109, 113])))
assert depth2.tolist() == [
    [[  3,   5,   7,         ],
     [ 13,  17,  19,  23,  29],
     [ 31,  37,  41,  43,  47]],
    [[ 53,  59,  61,  67,  71],
     [ 73,  79,  83,  89,  97],
     [101, 103, 107, 109, 113]]]

assert list(depth2.reduce(-3)) == [
    [ 159,  295,  427,   67,   71],
    [ 949, 1343, 1577, 2047, 2813],
    [3131, 3811, 4387, 4687, 5311]]

depth2 = ListOffsetArray([0, 3, 6], ListOffsetArray([0, 4, 8, 13, 18, 23, 28], RawArray([3, 5, 7, 11, 13, 17, 19, 23, 31, 37, 41, 43, 47, 53, 59, 61, 67, 71, 73, 79, 83, 89, 97, 101, 103, 107, 109, 113])))
assert depth2.tolist() == [
    [[  3,   5,   7,  11     ],
     [ 13,  17,  19,  23     ],
     [ 31,  37,  41,  43,  47]],
    [[ 53,  59,  61,  67,  71],
     [ 73,  79,  83,  89,  97],
     [101, 103, 107, 109, 113]]]

assert list(depth2.reduce(-3)) == [
    [ 159,  295,  427,  737,   71],
    [ 949, 1343, 1577, 2047,   97],
    [3131, 3811, 4387, 4687, 5311]]

depth2 = ListOffsetArray([0, 3, 6], ListOffsetArray([0, 5, 10, 14, 19, 24, 28], RawArray([2, 3, 5, 7, 11, 13, 17, 19, 23, 29, 31, 37, 41, 43, 53, 59, 61, 67, 71, 73, 79, 83, 89, 97, 101, 103, 107, 109])))
assert depth2.tolist() == [
    [[  2,   3,   5,   7,  11],
     [ 13,  17,  19,  23,  29],
     [ 31,  37,  41,  43     ]],
    [[ 53,  59,  61,  67,  71],
     [ 73,  79,  83,  89,  97],
     [101, 103, 107, 109     ]]]

assert list(depth2.reduce(-3)) == [
    [ 106,  177,  305,  469,  781],
    [ 949, 1343, 1577, 2047, 2813],
    [3131, 3811, 4387, 4687]]

depth2 = ListOffsetArray([0, 3, 6], ListOffsetArray([0, 5, 9, 14, 19, 23, 28], RawArray([2, 3, 5, 7, 11, 13, 17, 19, 23, 31, 37, 41, 43, 47, 53, 59, 61, 67, 71, 73, 79, 83, 89, 101, 103, 107, 109, 113])))
assert depth2.tolist() == [
    [[  2,   3,   5,   7,  11],
     [ 13,  17,  19,  23     ],
     [ 31,  37,  41,  43,  47]],
    [[ 53,  59,  61,  67,  71],
     [ 73,  79,  83,  89     ],
     [101, 103, 107, 109, 113]]]

assert list(depth2.reduce(-3)) == [
    [ 106,  177,  305,  469,  781],
    [ 949, 1343, 1577, 2047      ],
    [3131, 3811, 4387, 4687, 5311]]

depth2 = ListOffsetArray([0, 2, 4, 6], ListOffsetArray([0, 3, 4, 6, 6, 7, 9], RawArray(primes[:9])))
assert list(depth2) == [
    [[      2,   3, 5],
     [      7        ]],
    [[     11,  13   ],
     [               ]],
    [[     17        ],
     [     19,  23   ]]]

assert list(depth2.reduce(-3)) == [
    [2*11*17, 3*13, 5],
    [7*19   , 23     ]]

depth2 = ListOffsetArray([0, 2, 3, 5], ListOffsetArray([0, 3, 4, 6, 7, 9], RawArray(primes[:9])))
assert list(depth2) == [
    [[      2,   3, 5],
     [      7        ]],
    [[     11,  13   ]],
    [[     17        ],
     [     19,  23   ]]]

assert list(depth2.reduce(-3)) == [
    [2*11*17, 3*13, 5],
    [7*19   , 23     ]]

depth2 = ListOffsetArray([0, 3, 6], ListOffsetArray([0, 3, 5, 6, 8, 9, 10], RawArray(primes[:10])))
assert list(depth2) == [
    [[ 2,  3, 5],
     [ 7, 11   ],
     [13       ]],
    [[17, 19   ],
     [23       ],
     [29       ]]]

assert list(depth2.reduce(-3)) == [
    [ 34, 57, 5],
    [161, 11   ],
    [377       ]]

depth2 = ListOffsetArray([0, 4, 6], ListOffsetArray([0, 3, 3, 5, 6, 8, 9], RawArray(primes[:9])))
assert list(depth2) == [
    [[ 2,  3, 5],
     [         ],
     [ 7, 11   ],
     [13       ]],
    [[17, 19   ],
     [23       ]]]

assert list(depth2.reduce(-3)) == [
    [34, 57, 5],
    [23       ],
    [ 7, 11   ],
    [13       ]]

depth2 = ListOffsetArray([0, 4, 4, 6], ListOffsetArray([0, 3, 3, 5, 6, 8, 9], RawArray(primes[:9])))
assert list(depth2) == [
    [[ 2,  3, 5],
     [         ],
     [ 7, 11   ],
     [13       ]],
    [],
    [[17, 19   ],
     [23       ]]]

assert list(depth2.reduce(-3)) == [
    [34, 57, 5],
    [23       ],
    [ 7, 11   ],
    [13       ]]
